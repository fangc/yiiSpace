<div class="span9">
 <center><h1>新浪微博、腾讯微博：mysql数据库主表设计猜想</h1></center>
 <p></p>
<center>发布日期：2013-07-18 &nbsp;&nbsp;文章来源：互联网 &nbsp;&nbsp;浏览次数:147</center>
<hr>
 	<p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">用户信息表（t_user_info）</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字段名称</strong></p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字节数</strong></p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>类型</strong></p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>描述</strong></p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">User_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">用户编号（主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">User_name</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">20</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Char[20]</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">名称</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Msg_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">发布消息数量,可以作为t_msg_info水平切分新表的auto_increment</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Fans_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">粉丝数量</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Follow_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">关注对象数量</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">备注：以User_id取模分表<span id="more-1146"></span></p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">用户之间关系表（t_user_relation）,必须有关注与被关注的关系</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字段名称</strong></p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字节数</strong></p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>类型</strong></p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>描述</strong></p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">User_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">用户编号（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Follow_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">被关注者编号（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Type</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">1</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint8</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">关系类型（0，粉丝；1，关注）</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">备注：关系是单向的，以User_id取模分表</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">用户消息索引表（t_uer_msg_index）</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字段名称</strong></p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字节数</strong></p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>类型</strong></p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>描述</strong></p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">User_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">用户编号（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Author_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息发布者编号（可能是被关注者，也可能是自己）（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Msg_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息编号(由消息发布者的msg_count自增)（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Time_t</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">发布时间（必须是消息元数据产生时间）</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">备注：此表就是当我们点击“我的首页”时拉取的消息列表，只是索引，Time_t对这些消息进行排序</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">消息与消息关系表（t_msg_msg_relation）</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字段名称</strong></p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字节数</strong></p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>类型</strong></p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>描述</strong></p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Reference_id</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">引用消息用户编号（联合主键）</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Reference&nbsp;_msg_id</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">引用消息编号（联合主键）</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Referenced_id</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息发布者编号</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Referenced&nbsp;_msg_id</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">被引用消息编号</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Type</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">1</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint8</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">操作类型(1,评论；2，转发)</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Time_t</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">发布时间</p></td></tr><tr><td valign="top" width="138"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Page_index</p></td><td valign="top" width="69"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="68"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="201"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">转发或者评论页码</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">备注：以Reference_id取模分表。</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">腾讯微博比新浪微博好的一点是一个消息的所有评论和转发都是被固定页码，这样在点击看评论的时候搜索效率更 高，因为多了一个where Page_index的定位条件，当然带来的问题就是可能看到有些页的评论排版并不是满页，这就是因为标识为这个Page_index的评论有删除操作。</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">消息元数据表（t_msg_info）</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字段名称</strong></p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>字节数</strong></p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>类型</strong></p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;"><strong>描述</strong></p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">User_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">发消息用户编号（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Msg_id</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息编号（联合主键）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Content</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">140</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Char[140]</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息内容</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Type</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">1</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint8</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">消息类型（0，原创；1，评论；2，转发）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Commented_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">评论过数量（只增不减，删除评论不影响此值，可以作为评论多页显示的页码）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Comment_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">保留的评论数量</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Transferred_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">转发过数量（只增不减，删除转发不影响此值，可以作为转发多页显示的页码）</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Transfer_count</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">保留的转发数量</p></td></tr><tr><td valign="top" width="103"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Time_t</p></td><td valign="top" width="108"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">4</p></td><td valign="top" width="84"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">Uint32</p></td><td valign="top" width="273"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">发布时间</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">备注：消息元数据中，content像可能存在图片，这部分可以在分布式文件系统中存储。在2011年数据库大会上听杨海潮的演讲，对于nosql 也有涉及，本人能力有限，对这部分的职责还不清楚，希望高人指点。</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">非常推崇杨海潮ppt中的归档做法，因为微博是有时间轴线的，对于一定时间之前的记录可以分层次归档，这样在前端的最新的数据表的压力就会减轻很多。</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">业务逻辑：</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">1.A关注B</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">1）在t_user_relation_A中添加</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">A</p></td><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">B</p></td><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">1</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">2）在t_user_relation_B中添加</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">&nbsp;</p><table border="1" cellspacing="0" cellpadding="0" style="color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; font-size: 12px; line-height: 18px;"><tbody><tr><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">B</p></td><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">A</p></td><td valign="top" width="189"><p align="center" style="margin: 0px; padding: 0px 0px 15px;">0</p></td></tr></tbody></table><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">2.原创发消息<br>1）在t_msg_info_A中添加这条元消息，type为0<br>2）更新t_user_info_A中Msg_count<br>3）在t_uer_msg_index_A中插入A发的这条消息的索引（A的编号和消息编号）<br>4）在t_user_relation_A中找到所有关注A的人，比如B,C,D,E,F等等，并发在这些用户的t_uer_msg_index中插入A的这条信息索引，比如名人微博可以并发多个进程来实现对粉丝的消息同步</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">3.A转发B的消息msg_b<br>1）在t_msg_info_A中添加这条元消息msg_a，type为2<br>2）更新t_user_info_A中Msg_count<br>3）在t_uer_msg_index_A中插入A发的这条消息的索引（A的编号和消息编号）<br>4）在t_msg_info_B中更新msg_b的Transferred_count和Transfer_count<br>5）在t_msg_msg_relation中添加User_a,msg_a与User_b，msg_b的转发关系，page_index为Transferred_count%page_count</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">4.A评论B的消息msg_b<br>1）在t_msg_info_A中添加这条元消息msg_a，type为1<br>2）更新t_user_info_A中Msg_count<br>3）在t_uer_msg_index_A中插入A发的这条消息的索引（A的编号和消息编号）<br>4）在t_msg_info_B中更新msg_b的Commented_count和Comment_count</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">5）在t_msg_msg_relation中添加User_a,msg_a与User_b，msg_b的评论关系，page_index为Commented_count%page_count<br>5.A删除消息msg_a<br>1）删除t_msg_info中的元数据msg_a<br>2）删除t_uer_msg_index_A中的User_a，msg_a行记录<br>3）备注：如果A的msg_a被别人评论或者引用，那么在对方查看评论或者转发的时候会提示“原消息已被作者删除”</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">6.A删除转发消息msg_a<br>1）删除t_msg_info_A中的元数据msg_a<br>2）删除t_uer_msg_index_A中的User_a，msg_a行记录<br>3）在t_msg_msg_relation_A表中找到msg_a的源消息，即B的msg_b<br>4）删除t_msg_msg_relation_A中user_a，msg_a和user_b，msg_b的转发关系<br>5）更新t_msg_info_B中msg_b记录的Transfer_count，减1</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">7.A删除评论消息msg_a<br>1）删除t_msg_info_A中的元数据msg_a<br>2）删除t_uer_msg_index_A中的User_a，msg_a行记录<br>3）在t_msg_msg_relation_A表中找到msg_a的源消息，即B的msg_b<br>4）删除t_msg_msg_relation_A中user_a，msg_a和user_b，msg_b的评论关系<br>5）更新t_msg_info_B中msg_b记录的Commecnt_count，减1</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">8.A拉取全部消息</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">1）从t_uer_msg_index_A中拉取Author_id，Msg_id，Time_t索引，并以Time_t排序<br>2）通过页码和每页count控制返回结果数量，这样避免了server io 压力冲击</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">5月25日更新：</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">1）条件允许的话，所有的index表可以放到内存中，全部cache，而元数据直接ssd，这样读速度会提高很多，当然也要做好热备<br>2）t_user_relation表最好做合并存储</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">5月27日更新：</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">1）在第二步原创发消息要通知给粉丝，这时如果是明星，那么推送的数量可能数百万，新浪采取的做法是对这数百万粉丝进行区别对待，按照活跃度划分为几个层级，每个层级有一个推送时效限定，这样可以做到最想看到这个信息的人能够最及时的看到明星动态<br>2）用硬件来提升速度，将所有index表放在memory上，元数据放在ssd上，数据可以现在这两层上做处理，并定时持久化到mysql中<br>3）提供批量处理接口，比如拉取最新更新索引<br>4）在一定限度上容忍不一样，但要实现最终一致性</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">6月1日更新：<br>本文用的是push模式，关于微博的pull模式，请参见 http://www.mysqlops.com/2011/06/21/weibo-sns-feed-push-pull.html</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">6月30日更新：<br>在新浪微博中，评论和转发都与原创消息是一样的独立记录，只不过多了一条消息关系记录，在展现的时候除了要展现自己添加的转发内容或评论内容之外，还需要将最原始的那条目标消息取出来。</p><p style="margin: 0px; padding: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, Tahoma, Verdana; line-height: 18px;">原文作者：cleanfield<br>本文转自：http://blog.csdn.net/cleanfield/article/details/6339428</p> 	<p>转载请注明文章出处：<a href="http://www.dba-china.com/article/113.html" target="_blank">http://www.dba-china.com/article/113.html</a></p>
 <hr>

</div>

http://www.dba-china.com/article/113.html